{"version":3,"sources":["modules/install/controller.server.js"],"names":[],"mappings":";;;;;;AACA;;AACA;;AACA;;;;;;AAEA,MAAM,oBAAoB,CAAC,AAAD,GAAG,SAAH,EAAa,0BAAb,CAA1B;AACA,MAAM,OAAO,IAAI,IAAJ,EAAb;AACA,MAAM,qBAAqB,6CAA3B;;AAEA,MAAM,UAAU,IAAI,GAAJ,CACZ,qBAAY,iBAAZ,EACK,MADL,CACY;AAAA,WAAY,SAAS,QAAT,CAAkB,KAAlB,CAAZ;AAAA,CADZ,EAEK,GAFL,CAES;AAAA,WAAY,CAAC,SAAS,KAAT,CAAe,CAAf,KAAD,EAAwB,sBAAa,CAAC,AAAD,GAAG,iBAAH,EAAqB,AAArB,GAAuB,QAAvB,EAAgC,AAAhC,CAAb,EAAgD,QAAhD,EAAxB,CAAZ;AAAA,CAFT,CADY,CAAhB;;kBAMe,wBAAc;AACzB,SADyB,iBACnB,GADmB,EACd;AACP,YAAI,MAAJ,CAAW,EAAE,2BAAF,EAAX,EAAkC,EAAE,KAAK,IAAI,OAAJ,CAAY,MAAnB,EAAlC;AACH,KAHwB;AAKzB,UALyB,kBAKlB,GALkB,EAKb;AACR,YAAI,MAAJ,CAAW,IAAI,MAAJ,KAAe,MAAf,IAAyB,IAAI,MAAJ,KAAe,KAAnD,EAA0D,GAA1D;AACA,cAAM,aAAa,IAAI,KAAJ,CAAU,WAAV,CAAsB,GAAtB,CAA0B,YAA1B,CAAnB;AACA,YAAI,aAAa,QAAQ,GAAR,CAAY,UAAZ,CAAjB;AACA,YAAI,MAAJ,CAAW,UAAX,EAAuB,GAAvB;AACA,YAAI,GAAJ,CAAQ,eAAR,EAAyB,KAAK,WAAL,EAAzB;;AAEA,YAAI,eAAe,mBAAnB,EAAwC;AACpC,yBAAa,WAAW,OAAX,CAAmB,kBAAnB,EAAuC,CAAC,KAAD,GAAQ,IAAI,OAAJ,CAAY,MAApB,EAA2B,kBAA3B,CAAvC,CAAb;AACH,SAFD,MAEO,IAAI,eAAe,gBAAnB,EAAqC;AACxC,yBAAa,WAAW,OAAX,CACT,kBADS,EAET,CAAC,iBAAD,GAAoB,IAAI,OAAJ,CAAY,MAAhC,EAAuC,eAAvC,GAAwD,IAAI,GAAJ,CAAQ,MAAR,CAAe,GAAf,CAAmB,WAAnB,EAAgC,GAAhC,CAAoC,MAApC,CAAxD,EAAoG,AAApG,CAFS,CAAb;AAIH;;AAED,YAAI,IAAJ,GAAW,UAAX;AACH;AAtBwB,CAAd,C","file":"modules/install/controller.server.js","sourcesContent":["if (global.BROWSER) throw new Error();\nimport { newController } from 'alp';\nimport { readdirSync, readFileSync } from 'fs';\nimport InstallView from './InstallView';\n\nconst installScriptsDir = `${__dirname}/../../../install-scripts/`;\nconst date = new Date();\nconst CONFIG_PLACEHOLDER = '### SERVER CONFIG WILL BE INJECTED HERE ###';\n\nconst scripts = new Map(\n    readdirSync(installScriptsDir)\n        .filter(filename => filename.endsWith('.sh'))\n        .map(filename => [filename.slice(0, -3), readFileSync(`${installScriptsDir}${filename}`).toString()])\n);\n\nexport default newController({\n    index(ctx) {\n        ctx.render({ View: InstallView }, { url: ctx.request.origin });\n    },\n\n    script(ctx) {\n        ctx.assert(ctx.method === 'HEAD' || ctx.method === 'GET', 405);\n        const scriptName = ctx.route.namedParams.get('scriptName');\n        let scriptBody = scripts.get(scriptName);\n        ctx.assert(scriptBody, 404);\n        ctx.set('Last-Modified', date.toUTCString());\n\n        if (scriptName === 'install-raspberry') {\n            scriptBody = scriptBody.replace(CONFIG_PLACEHOLDER, `URL=\"${ctx.request.origin}/install-scripts/\"`);\n        } else if (scriptName === 'install-client') {\n            scriptBody = scriptBody.replace(\n                CONFIG_PLACEHOLDER,\n                `SERVER_HOSTNAME=\"${ctx.request.origin}\"\\nSERVER_PORT=${ctx.app.config.get('webSocket').get('port')}`\n            );\n        }\n\n        ctx.body = scriptBody;\n    },\n});\n"],"sourceRoot":"/"}